<?php
declare(strict_types=1);
namespace app;
use attr;
/** @var callable $var */
$attrs = $var('attr');
$actions = $var('action');
$sort = $var('sort');
$table = $var('table');
$title = $var('title');
?>
<section class="block-index">
    <?php if ($title): ?>
    <h2><?php echo $title; ?></h2>
    <?php endif; ?>
    <?php echo $var('filter'); ?>
    <div class="content<?php if ($table): ?> table<?php endif; ?>">
        <?php if ($table): ?>
        <div class="thead">
            <?php foreach ($attrs as $attr): ?>
                <?php
                $qsort = ($attr['id'] === $sort ? '-' : '') . $attr['id'];
                $sorted = $sort && $attr['id'] === ltrim($sort, '-');
                $dir = $sort && $sort[0] === '-' ? 'desc' : 'asc';
                ?>
            <a<?php if ($var('sortable')): ?>
                href="<?php echo urlquery(['sort' => $qsort], true); ?>"<?php if ($sorted): ?>
                data-sort="<?php echo $dir; ?>"<?php endif; ?><?php endif; ?>
                data-attr="<?php echo $attr['id']; ?>"
                data-type="<?php echo $attr['type']; ?>"
            ><?php echo $attr['name']; ?></a>
            <?php endforeach; ?>
            <?php if ($actions): ?>
            <a class="action"><?php echo i18n('Actions'); ?></a>
            <?php endif; ?>
        </div>
        <?php endif; ?>
        <?php foreach ($var('data') as $id => $data): ?>
            <?php
            $entityId = $data['entity_id'] ?? $data['_entity']['id'];
            $entity = $entityId === $data['_entity']['id'] ? $data['_entity'] : cfg('entity', $entityId);
            $dataId = $entityId . '-' . $id;
            $name = $data['name'] ?? $id;
            $src = $entity['parent_id'] === 'file' ? $data['name'] : null;
            ?>
        <article
            data-id="<?php echo $dataId; ?>"
            data-name="<?php echo $name; ?>"<?php if ($src): ?>
            data-src="<?php echo $src; ?>"<?php endif; ?>
        >
            <?php foreach ($attrs as $attr): ?>
            <?php echo attr\viewer($data, $attr, wrap: true, preserve: true, subheading: true); ?>
            <?php endforeach; ?>
            <?php if ($actions): ?>
            <footer class="action">
                <?php foreach ($actions as $action): ?>
                    <?php if (!allowed(id($entityId, $action))) continue; ?>
                    <?php
                    $label = i18n(ucwords($action));
                    $url = actionurl($entityId, $action, $id);
                    $url = $action === 'view' && !empty($data['url']) ? $data['url'] : $url;
                    ?>
                <a
                    href="<?php echo $url; ?>"
                    data-action="<?php echo $action; ?>"
                    title="<?php echo $label; ?>"
                ><?php echo $label; ?></a>
                <?php endforeach; ?>
            </footer>
            <?php endif; ?>
        </article>
        <?php endforeach; ?>
    </div>
    <?php echo $var('pager'); ?>
</section>
