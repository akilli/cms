def reg = "registry.ayhan.biz"
def app = "cms"
def img = "${reg}/${app}-data"
def srv = "${app}-data"
def big = "akilli/postgres"
def vda = "${app}_data"
def vdb = "${app}_db"
def cre = "ci"
def oid = ""
def nid = ""

pipeline {
    agent any

    options {
        buildDiscarder(logRotator(numToKeepStr: '1'))
        disableConcurrentBuilds()
    }

    stages {
        stage("Checkout") {
            steps {
                checkout scm
            }
        }

        stage("Build") {
            steps {
                script {
                    oid = sh(returnStdout: true, script: "sudo docker inspect --format='{{.Id}}' ${img} || true").trim()
                }

                script {
                    con = sh(returnStdout: true, script: "sudo docker run -d -v ${vda}:/vol-data -v ${vdb}:/vol-db ${big}").trim()
                    sleep 10
                    sh "sudo docker exec ${con} ash -c 'rm -rf /app /data && cp -R /vol-data /app && cp -R /vol-db /data && chown -R app:app /app /data'"
                    sh "sudo docker commit ${con} ${img}"
                    sh "sudo docker rm -f ${con}"
                }

                script {
                    nid = sh(returnStdout: true, script: "sudo docker inspect --format='{{.Id}}' ${img} || true").trim()
                }
            }
        }

        stage("Registry") {
            steps {
                withCredentials([usernamePassword(credentialsId: cre, passwordVariable: 'pass', usernameVariable: 'user')]) {
                    sh "sudo docker login -u ${user} -p ${pass} ${reg}"
                    sh "sudo docker push ${img}"
                }
            }
        }

        stage("Live") {
            steps {
                sh "sudo docker-compose -p ${app} -f docker-compose.yml stop ${srv}"
                sh "sudo docker-compose -p ${app} -f docker-compose.yml rm -f ${srv}"
                sh "sudo docker-compose -p ${app} -f docker-compose.yml up -d --force-recreate"
            }
        }

        stage("Clean") {
            steps {
                deleteDir()

                script {
                    if (oid && !oid.equals(nid)) {
                        sh "sudo docker rmi ${oid}"
                    }
                }
            }
        }
    }
}
